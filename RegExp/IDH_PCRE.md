# 正则表达式语法

## 目录
- [PCRE 正则表达式详情](#pcre-正则表达式详情)
- [反斜杠](#反斜杠)
- [插入符和美元符号](#插入符和美元符号)
- [点号](#点号)
- [匹配单个字节](#匹配单个字节)
- [方括号](#方括号)
- [POSIX 字符类](#posix-字符类)
- [竖线](#竖线)
- [内部选项设置](#内部选项设置)
- [子模式](#子模式)
- [命名子模式](#命名子模式)
- [重复](#重复)
- [原子分组和占有量词](#原子分组和占有量词)
- [反向引用](#反向引用)
- [断言](#断言)
- [条件子模式](#条件子模式)
- [注释](#注释)
- [递归模式](#递归模式)
- [子模式作为子例程](#子模式作为子例程)
- [调用](#调用)

**另见：**
- [findrx](IDP_FINDRX.md)、[str.replacerx](IDP_S_REPLACERX.md)
- [正则表达式选项（标志）](IDP_PCREFLAGS.md)
- [关于正则表达式；代码示例](IDP_PCRE.md)
- [Unicode 模式（UTF-8）中的正则表达式](IDP_PCRE.md#utf8)

## PCRE 正则表达式详情

PCRE（Perl 兼容正则表达式）是一种强大的模式匹配工具，其语法和语义在以下部分详细描述。正则表达式相关内容也可在 Perl 文档及相关书籍（如 Jeffrey Friedl 的《Mastering Regular Expressions》）中找到。以下内容作为参考文档。

PCRE 主要操作字节字符串，但也支持 UTF-8 字符字符串（需使用 `RX_UTF8` 选项）。**注意：QM 不支持正则表达式的 UTF-8 模式**（详情见 [IDP_PCRE.md](IDP_PCRE.md)）。

正则表达式是从左到右匹配目标字符串的模式。大多数字符表示其本身，例如：

```regex
The quick brown fox
```

匹配与其完全相同的字符串部分。正则表达式的强大之处在于通过**元字符**支持替代和重复。元字符不表示其本身，而是具有特殊含义。

在模式中，元字符分为两类：
- **方括号外**的元字符：
  ```regex
  \       通用转义字符
  ^       断言字符串（或行，在多行模式下）开头
  $       断言字符串（或行，在多行模式下）结尾
  .       匹配除换行符外的任意字符（默认）
  [       开始字符类定义
  |       开始替代分支
  (       开始子模式
  )       结束子模式
  ?       扩展 ( 的含义；也表示 0 或 1 次量词，或量词最小化
  *       0 次或多次量词
  +       1 次或多次量词；也表示“占有量词”
  {       开始最小/最大量词
  ```
- **方括号内**（字符类）的元字符：
  ```regex
  \       通用转义字符
  ^       否定字符类（仅当为第一个字符时）
  -       表示字符范围
  [       POSIX 字符类（仅当后接 POSIX 语法）
  ]       结束字符类
  ```

以下各节详细描述每个元字符的用法。

## 反斜杠

反斜杠（`\`）有多种用途：

1. **转义非字母数字字符**：去除后续字符的特殊含义，适用于字符类内外。例如，匹配 `*` 需写为 `\*`，匹配 `\` 需写为 `\\`。即使后续字符无特殊含义，也可安全使用反斜杠转义。

2. **转义序列忽略空白和注释**：当使用 `RX_EXTENDED` 选项时，模式中的空白（字符类外）和 `#` 到换行符之间的字符被忽略。使用反斜杠可将空白或 `#` 纳入模式。

3. **\Q...\E 转义序列**：将 `\Q` 和 `\E` 之间的字符视为字面量，忽略其特殊含义（与 Perl 不同，PCRE 的 `\Q...\E` 中 `$` 和 `@` 不触发变量插值）。示例：
   ```regex
   Pattern           PCRE 匹配        Perl 匹配
   \Qabc$xyz\E       abc$xyz         $xyz 的内容
   \Qabc\$xyz\E      abc\$xyz        abc\$xyz
   \Qabc\E\$\Qxyz\E  abc$xyz         abc$xyz
   ```

4. **非打印字符转义序列**：
   ```regex
   \a         警报（BEL，十六进制 07）
   \cx        控制字符“control-x”（x 为任意字符）
   \e         转义（十六进制 1B）
   \f         换页（十六进制 0C）
   \n         换行（十六进制 0A）
   \r         回车（十六进制 0D）
   \t         制表符（十六进制 09）
   \ddd       八进制代码 ddd 的字符，或反向引用
   \xhh       十六进制代码 hh 的字符
   \x{hhh..} 十六进制代码 hhh.. 的字符（仅 UTF-8 模式）
   ```
   - `\cx`：若 x 为小写字母，转换为大写，然后反转字符的第 6 位（十六进制 40）。例如，`\cz` 为 1A，`\c{` 为 3B，`\c;` 为 7B。
   - `\x`：读取 0 到 2 个十六进制数字（大小写均可）。在 UTF-8 模式下，`\x{...}` 支持任意数量的十六进制数字（值需小于 2^31）。
   - `\0`：读取最多两个八进制数字。若后续字符为八进制数字，需确保提供两位数字以避免歧义。

5. **数字后的反斜杠**：
   - **字符类外**：若后接非 0 数字，视为十进制数字。若数字小于 10 或之前有足够多的捕获括号，则为**反向引用**（见下文）。否则，读取最多三个八进制数字，生成单个字节。例如：
     ```regex
     \040     等同于空格
     \40      若少于 40 个捕获子模式，等同于空格
     \7       总是反向引用
     \11      可能为反向引用，或制表符
     \011     总是制表符
     \0113    制表符后接字符 "3"
     \113     可能为反向引用，或八进制代码 113 的字符
     \377     可能为反向引用，或全 1 字节
     \81      反向引用，或二进制零后接 "8" 和 "1"
     ```
   - **字符类内**：反斜杠后接最多三个八进制数字，生成单个字节，剩余数字按字面量处理。
   - 八进制值 100 或以上不得以 0 开头，因最多读取三个八进制数字。

6. **通用字符类型**：
   ```regex
   \d       任意十进制数字
   \D       非十进制数字
   \s       任意空白字符（HT、LF、FF、CR、空格；VT 不包含）
   \S       非空白字符
   \w       任意“单词”字符（字母、数字、下划线）
   \W       非“单词”字符
   ```
   - 每对转义序列将字符集分为两个互斥集合。
   - 在 UTF-8 模式下，值大于 255 的字符不匹配 `\d`、`\s` 或 `\w`，但匹配 `\D`、`\S` 和 `\W`。
   - `\s` 不包含 VT（代码 11），以保持与 Perl 的兼容性。

7. **简单断言**：
   ```regex
   \b       匹配单词边界
   \B       匹配非单词边界
   \A       匹配字符串开头
   \Z       匹配字符串结尾或结尾前的换行符
   \z       仅匹配字符串结尾
   \G       匹配当前匹配的起始位置
   ```
   - 单词边界：当前字符与前一字符一个匹配 `\w`，另一个匹配 `\W`，或字符串开头/结尾的 `\w` 字符。
   - `\A`、`\Z` 和 `\z` 不受多行模式影响，仅匹配字符串的绝对开头和结尾。`\Z` 在字符串末尾换行符前也匹配，`\z` 仅匹配末尾。
   - `\G` 仅在匹配起始位置（由 `from` 参数指定）为真，与 `\A` 在 `startoffset` 非零时不同。支持类似 Perl 的 `/g` 选项。
   - 若模式所有分支以 `\G` 开头，则模式锚定到起始匹配位置。

**另见**：[QM 转义序列](IDP_CONSTANT.md)

## 插入符和美元符号

**插入符（`^`）**：
- **字符类外**：默认模式下，断言当前匹配点为字符串开头。若 `from` 参数非零且未设置 `RX_MULTILINE`，`^` 不匹配。模式若以 `^` 开头（或所有分支以 `^` 开头），则为**锚定**模式，仅匹配字符串开头。
- **多行模式（`RX_MULTILINE`）**：匹配字符串开头或内部换行符后。

**美元符号（`$`）**：
- **字符类外**：默认模式下，断言当前匹配点为字符串结尾，或末尾换行符前。若设置 `RX_DOLLAR_ENDONLY`，仅匹配字符串绝对结尾（不影响 `\Z`）。
- **多行模式（`RX_MULTILINE`）**：匹配字符串结尾或内部换行符前。
- QM 中，`$` 和 `\Z` 匹配 `\n` 和 `\r\n`。

**注意**：`\A`、`\Z` 和 `\z` 不受 `RX_MULTILINE` 影响，始终匹配字符串绝对开头或结尾。

## 点号

**点号（`.`）**：
- **字符类外**：匹配除换行符外的任意字符。若设置 `RX_DOTALL`，也匹配换行符。
- **字符类内**：无特殊含义，表示字面点号。
- 与 `^` 和 `$` 的处理无关，仅涉及换行符。

## 匹配单个字节

**`\C`**：
- 字符类外，匹配任意单个字节（包括换行符），在 UTF-8 模式下可能破坏字符完整性，应避免使用。
- 不可用于后向断言，因其长度无法计算。

## 方括号

**方括号（`[ ]`）**定义字符类，匹配单个字符：
- 以 `[` 开头，以 `]` 结束。单独的 `]` 无特殊含义。
- 若需将 `]` 包含在字符类中，需作为第一个数据字符（在初始 `^` 后）或用反斜杠转义。
- **UTF-8 模式**：可匹配多字节字符，可用字面字节或 `\x{...}` 指定。
- **否定字符类**：以 `^` 开头，匹配不在集合中的字符。例如：
  ```regex
  [aeiou]      匹配小写元音
  [^aeiou]     匹配非小写元音
  ```
  - `^` 仅为方便表示法，仍消耗一个字符。若匹配点在字符串末尾，失败。
- **大小写无关（`RX_CASELESS`）**：字母匹配大小写版本（如 `[aeiou]` 匹配 `A` 和 `a`）。值大于 255 的字符不受支持。
- **换行符**：字符类中始终按字面量处理，不受 `RX_DOTALL` 或 `RX_MULTILINE` 影响。
- **范围（`-`）**：指定字符范围，如 `[d-m]` 匹配 `d` 到 `m` 的字母。若需字面 `-`，需转义或置于首位/末尾。范围按字符值排序，支持数字范围（如 `[\000-\037]`）和 UTF-8 字符范围（如 `[\x{100}-\x{2ff}]`）。
- **字符类型**：支持 `\d`、`\D`、`\s`、`\S`、`\w`、`\W`，添加对应字符。例如，`[\dABCDEF]` 匹配十六进制数字，`[^\W_]` 匹配字母或数字（非下划线）。
- **非元字符**：除 `\`、`-`、`^`（首位）和 `]` 外，其他非字母数字字符无特殊含义，但可安全转义。

## POSIX 字符类

PCRE 支持 POSIX 字符类，格式为 `[:name:]`，在方括号内使用。例如：

```regex
[01[:alpha:]%]
```

匹配 `0`、`1`、字母或 `%`。支持的 POSIX 字符类：
```regex
alnum    字母和数字
alpha    字母
ascii    字符代码 0-127
blank    空格或制表符
cntrl    控制字符
digit    十进制数字（同 \d）
graph    可打印字符（不含空格）
lower    小写字母
print    可打印字符（含空格）
punct    标点符号（不含字母和数字）
space    空白字符（HT、LF、VT、FF、CR、空格；与 \s 不同）
upper    大写字母
word     “单词”字符（同 \w）
xdigit   十六进制数字
```

- **否定**：在 `[:` 后加 `^`，如 `[12[:^digit:]]` 匹配 `1`、`2` 或非数字。
- **注意**：`space` 包含 VT（代码 11），而 `\s` 不包含。`word` 和 `blank` 为 Perl/GNU 扩展。
- **UTF-8 模式**：值大于 255 的字符不匹配 POSIX 字符类。
- 不支持 POSIX 排序元素（`[.ch.]`）和等价类（`[=ch=]`），否则报错。

## 竖线

**竖线（`|`）**分隔替代模式。例如：

```regex
gilbert|sullivan
```

匹配 `gilbert` 或 `sullivan`。支持任意数量的替代，允许空替代（匹配空字符串）。从左到右尝试每个替代，首个成功即用。若替代在子模式内，成功需匹配子模式及主模式剩余部分。

## 内部选项设置

模式内可通过 `(?...)` 更改 `RX_CASELESS`、`RX_MULTILINE`、`RX_DOTALL` 和 `RX_EXTENDED` 选项，选项字母为：

```regex
i    RX_CASELESS（大小写无关）
m    RX_MULTILINE（多行模式）
s    RX_DOTALL（点号匹配换行符）
x    RX_EXTENDED（忽略空白和注释）
```

示例：
```regex
(?im)        设置大小写无关和多行模式
(?im-sx)     设置 RX_CASELESS 和 RX_MULTILINE，取消 RX_DOTALL 和 RX_EXTENDED
```

- **取消选项**：在字母前加 `-`，如 `(?-i)`。
- **作用范围**：顶级选项更改影响后续模式；在子模式内仅影响后续部分。例如：
  ```regex
  (a(?i)b)c    匹配 abc 或 aBc
  (a(?i)b|c)   匹配 ab、aB、c 或 C
  ```
- **PCRE 特定选项**：`RX_UNGREEDY`（`U`）和 `RX_EXTRA`（`X`）也支持，`(?X)` 需在模式开头。

## 子模式

子模式由圆括号（`()`）定义，可嵌套，具有以下作用：
1. **局部化替代**：例如：
   ```regex
   cat(aract|erpillar|)
   ```
   匹配 `cat`、`cataract` 或 `caterpillar`。无括号则匹配 `cataract`、`erpillar` 或空字符串。
2. **捕获子模式**：捕获匹配的子字符串，从左到右编号（从 1 开始）。例如：
   ```regex
   the ((red|white) (king|queen))
   ```
   匹配 `the red king`，捕获子字符串为 `red king`（1）、`red`（2）、`king`（3）。
- **非捕获子模式**：以 `(?:...)` 开头，不捕获且不计入编号。例如：
  ```regex
  the ((?:red|white) (king|queen))
  ```
  匹配 `the white queen`，捕获 `white queen`（1）、`queen`（2）。
- 最大捕获子模式数为 65535，所有子模式（捕获和非捕获）嵌套深度最大为 200。
- 非捕获子模式开头可包含选项，如 `(?i:saturday|sunday)`。

## 命名子模式

捕获子模式可通过 Python 语法 `(?P<name>...)` 命名，名称由字母、数字和下划线组成，模式内需唯一。命名子模式仍分配编号。例如：
```regex
(?P<p1>(?i)rah)\s+(?P=p1)
```

## 重复

量词指定重复次数，适用于：
- 字面字符
- 点号（`.`）
- `\C` 转义序列
- 单字符转义（如 `\d`）
- 字符类
- 反向引用
- 非断言的子模式

**通用量词**：`{min,max}` 指定最小和最大匹配次数（均小于 65536，min ≤ max）。例如：
```regex
z{2,4}       匹配 zz、zzz 或 zzzz
[aeiou]{3,}  至少 3 个元音
\d{8}        正好 8 个数字
```
- 若省略 max 但有逗号，无上限；若省略 max 和逗号，为精确次数。
- `{0}` 使前项和量词无效。
- **UTF-8 模式**：量词应用于字符而非字节。

**缩写量词**：
```regex
*    等同于 {0,}
+    等同于 {1,}
?    等同于 {0,1}
```

**贪婪与非贪婪**：
- 默认贪婪，匹配尽可能多次（至最大次数）。例如，`/\*.*\*/` 匹配 `/* first */ not /* second */` 会失败，因 `.*` 匹配整个字符串。
- 量词后加 `?` 变为非贪婪，匹配最少次数。例如，`/\*.*?\*/` 正确匹配 C 注释。
- `RX_UNGREEDY` 选项反转默认行为，量词后加 `?` 变为贪婪。
- 例如，`\d??\d` 优先匹配一个数字，但若需两个则匹配两个。

**注意**：
- 无限循环（如 `(a?)*`）现被接受，但若子模式匹配空字符串，循环强制中断。
- 若模式以 `.*` 或 `.{0,}` 开头且设置 `RX_DOTALL`，模式隐式锚定到 `\A`，除非 `.*` 在捕获括号内且有反向引用。

## 原子分组和占有量词

**原子分组**：以 `(?>...)` 开头，匹配后锁定子模式，阻止回溯。例如：
```regex
(?>\d+)bar
```
匹配 `123456bar` 时，若 `bar` 失败，立即放弃（不尝试更少数字）。

**占有量词**：量词后加 `+`，如 `\d++bar`，等同于原子分组，总是贪婪，忽略 `RX_UNGREEDY`。例如：
```regex
(\D+|<\d+>)*[!?]
```
匹配非数字或 `<数字>` 序列后接 `!` 或 `?`，若无原子分组，匹配长字符串可能极慢。使用 `((?>\D+)|<\d+>)*[!?]` 可快速失败。

## 反向引用

**反向引用**：字符类外，反斜杠后接大于 0 的数字（或更多数字），引用前面的捕获子模式（需有足够多的捕获括号）。若数字小于 10，总是反向引用，否则需检查捕获数。例如：
```regex
(sens|respons)e and \1ibility
```
匹配 `sense and sensibility` 和 `response and responsibility`，但不匹配 `sense and responsibility`。

- **大小写敏感**：引用时大小写需匹配。例如，`((?i)rah)\s+\1` 匹配 `rah rah` 和 `RAH RAH`，但不匹配 `RAH rah`。
- **命名反向引用**：使用 `(?P=name)`，如 `(?P<p1>(?i)rah)\s+(?P=p1)`。
- 同一子模式可多次引用。若子模式未匹配，引用失败。
- 引用数字后若接数字，需用分隔符（如空格或空注释）终止引用（若设 `RX_EXTENDED`）。
- 引用不得在自身括号内使用（如 `(a\1)` 无效），但在重复子模式中有效，例如：
  ```regex
  (a|b\1)+    匹配多个 a 或 aba、ababbaa 等
  ```

## 断言

**断言**测试当前匹配点前后字符，不消耗字符。简单断言（如 `\b`、`\A` 等）见上文。复杂断言使用子模式：
- **前向断言**：
  - 正向：`(?=...)`，匹配后接指定模式的点。例如，`\w+(?=;)` 匹配后接 `;` 的单词，不包含 `;`。
  - 负向：`(?!...)`，匹配不后接指定模式的点。例如，`foo(?!bar)` 匹配非后接 `bar` 的 `foo`。
- **后向断言**：
  - 正向：`(?<=...)`，匹配前接指定模式的点。例如，`(?<=foo)bar` 匹配前接 `foo` 的 `bar`。
  - 负向：`(?<!...)`，匹配不前接指定模式的点。例如，`(?<!foo)bar` 匹配非前接 `foo` 的 `bar`。
  - 后向断言的所有分支需匹配固定长度字符串。例如，`(?<=bullock|donkey)` 有效，`(?<!dogs?|cats?)` 无效。
- **注意**：
  - `(?!foo)bar` 不匹配前接非 `foo` 的 `bar`，而是匹配任意 `bar`（因 `(?!foo)` 对 `bar` 总为真）。需用后向断言。
  - 空断言 `(?!)` 总失败，因空字符串总匹配。
  - 断言不捕获，但正向断言内的捕获子模式计入编号。
  - 断言可嵌套或连续使用。例如：
    ```regex
    (?<=
```