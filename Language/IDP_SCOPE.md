# 变量存储和作用域

## 局部（自动）变量
- 局部变量仅存在于声明它们的函数或宏中，无法直接在其他函数中访问。不同函数中可使用相同变量名，但它们是不同的变量。
- 声明示例：
  ```cpp
  int i
  ```
- 函数[参数](IDP_FUNCTION.html)也是局部变量。
- 局部变量仅在函数执行期间存在，进入函数时自动创建，离开时自动销毁。每个执行的函数实例拥有独立的局部变量集。
- 存储于栈上，按声明顺序排列，4 字节对齐（1-4 字节变量占 4 字节，5-8 字节占 8 字节等）。复合类型（`str`、`BSTR`、`ARRAY`、`VARIANT`、接口指针）可能关联动态内存，分配自动完成。

## 全局（静态）变量
- 全局变量在当前进程（QM 或 EXE）中的所有函数和宏共享，用于在不同宏或同一宏的多个实例间共享数据。
- 声明示例（使用 `+`）：
  ```cpp
  int+ g_Variable
  ```
- 在[编译](../QM_Help/IDH_DEBUG.html)声明的函数或宏时创建，关闭 QM 文件（例如 QM 退出）时销毁。
- 同一全局变量可在多处声明多次。若声明时赋值（如 `int+ g_v1=1`），每次声明都会执行赋值。
- 建议尽量避免使用全局变量，优先使用局部变量、线程变量或通过函数参数传递数据。
- 为避免混淆和冲突，使用描述性名称（如加 `g_` 前缀），或使用[用户定义类型](IDP_TYPE.html)将相关变量存储在单一变量中。
- 若多[线程](../Other/IDP_THREADS.html)同时访问全局变量，使用 [lock](../Commands/IDP_LOCK.html) 防止数据竞争，否则可能导致错误、内存损坏或 QM 不稳定。
- 若宏在[独立进程](../QM_Help/IDH_MAKEEXE.html#a8)运行，拥有独立的全局变量。例如，使用全局变量 `g_x` 的宏 A（在 QM 中运行）、宏 B 和 C（在独立进程运行）无法通过 `g_x` 共享数据。可使用[注册表](../Functions/IDP_RGET.html)、文件或 Windows API（如共享内存，QM 提供 `__SharedMemory` 类简化操作）共享数据。

## 线程变量
- 线程变量在同一[线程](../Other/IDP_THREADS.html)（运行宏）中的所有函数间共享，需在每个使用它们的函数中声明。
- 声明示例（使用 `-`）：
  ```cpp
  int- t_i
  ```
- 在线程中首次声明的函数开始时创建，线程退出（宏结束）时销毁。
- 若声明时赋值，赋值仅在线程执行期间首次执行（不同于局部和全局变量）。示例：
  ```cpp
  int- t_i=5 ;; 即使多次遇到此行，仅首次赋值 5
  ```
- **另见**：[特殊线程中的线程变量](../Other/IDP_THREADS.html)

## 私有线程变量
- 使用 `--` 声明的线程变量仅在声明它们的函数中可见。
- 声明示例：
  ```cpp
  int-- t_i
  ```

## 成员变量和函数
- [类](IDP_CLASSES.html)成员可在该类的所有成员函数中使用，使用 `member` 或 `this.member` 访问，而非 `variable.member`。

## 子函数父变量
- 具有 `v` 属性的[子函数](IDP_DIR_SUB.html)可使用父函数的局部变量。

## 应用变量（已过时）
- 具有[“Application”属性](../QM_Help/IDH_FOLDERPROP.html)的文件夹主函数的局部变量，在该应用文件夹的其他函数中也可见。

## 作用域优先级
若存在多个同名但作用域不同的变量或函数，QM 按以下优先级选择：
1. 预定义（[QM 语言关键字、内置函数](../Reference/IDH_REFERENCE.html)、[特殊变量/常量](IDP_SPECVAR.html)、[内置类型](IDH_VARIABLES.html)、[其他 QM 定义类型](../_COM/IDP_OLETYPES.html)）。除类/类型成员外，不可声明与预定义名称相同的变量。
2. 局部变量和线程变量。
3. 类成员函数中的类成员（变量和函数）及其基类成员。
4. 具有 `v` 属性的子函数中的父函数局部变量。
5. 应用主函数变量（已过时）。
6. 全局函数、变量、类型等。

在类成员函数中：
- 若类成员名称与预定义名称冲突，使用 `this.member` 访问成员。
- 若类成员名称与全局名称冲突，使用 `__not_this.global` 访问全局标识符，`__not_this` 为 QM 2.4.3 添加的[类别](IDP_CATEGORIES.html)，也可用其他类别名称。

**另见**：[更多存储类型](IDP_SCOPE2.html)、[预定义变量](IDP_SPECVAR.html)