# <img src="../image/icon_tsm.gif"> 自动文本列表

## 概述

自动文本列表用于在输入特定文本时执行命令。典型用途包括文本替换、自动完成和自动更正，也称为文本敏感菜单或 TS 菜单。

自动文本列表没有可见界面。当在某处输入文本并匹配列表中的某项时，执行对应的命令。

## 触发器

自动文本列表必须具有触发器才能生效。

### 文本触发器

**QM 2.3.3 新增**

示例（`/b/i/c/p3` 设置选项）：

```qm
/b/i/c/p3
sun :'"Sunday"
mon :'"Monday"
```

当输入 `sun` 后跟分隔符（例如空格）时，会将文本替换为 `Sunday `（删除 `sun ` 并输入 `Sunday `）。也可以按 Ctrl 代替分隔符。输入 `mon ` 时，替换为 `Monday `。

此触发器无需在输入文本前触发事件（如热键），仅激活自动文本列表。其他 QM 项目类型无法使用此触发器。

通过[属性对话框](IDH_PROPERTIES.md)分配此触发器。可以设置自动文本列表生效的程序和[过滤函数](#MoreOptions)。还可以设置前缀文本，例如前缀为 `##`，则需输入 `##sun ` 或 `##mon `。

### 其他触发器

如果需要在输入文本前使用热键或其他触发器，可使用以下方式。

示例（`/b/i/c` 设置选项）：

```qm
/b/i/c
sun :'"Sunday"
mon :'"Monday"
```

- **热键触发**：假设触发器为 F12。按 F12 后输入 `sun`，将文本替换为 `Sunday`；输入 `mon`，替换为 `Monday`。

- **非“Eat”触发**：假设触发器为键 ```，且未选中“Eat”。输入 ``sun` 时，替换为 `Sunday`；输入 ``mon` 时，替换为 `Monday`。

**注意**：不应使用字母数字键作为触发器，建议使用文本触发器。如果使用字母键并设置 `/i`（大小写不敏感），在触发器选项卡中将 Shift 复选框设置为第三状态。

### 注意事项

- **QM 2.3.3**：自动文本列表必须有触发器才能工作。若使用 `mac` 或其他方式激活，需先分配触发器（除文本触发器外的任意触发器）。如果列表或 QM 被禁用，自动文本列表无效。

- **QM 2.3.3**：如果在选项 -> 触发器中禁用，所有自动文本列表均无效，无论触发器类型。

## 列表项目

自动文本列表文本是每行一个项目的列表，格式如下：

```qm
text :statements
```

- **text**：触发执行 `statements` 的输入文本。
  - 可以使用任意字符，包括空格、制表符和换行符。
  - 支持[转义序列](IDP_CONSTANT.md)。

- **statements**：宏中可用的任意命令。
  - 多条语句用分号分隔。

**分隔符**：`text` 和 `statements` 之间用单个空格和冒号（` :`）分隔。例如，行 `mail  :"name@abc.com"`（mail 后有两个空格），在输入 ``mail ``（带空格）时执行命令。

- 不含 ` :` 且不以 `/` 开头的行被忽略，可用于注释。
- **QM 2.3.3**：以空格开头的行是注释。如需空格，使用转义序列 `[32]`。

## 选项

以 `/` 开头的行用于设置后续项目的选项（直到下一个选项行）。也可以通过属性对话框设置选项。选项如下：

| 选项 | 描述 |
|------|------|
| /s   | 选择输入的文本，使用 Shift+Left 键。 |
| /b   | 删除输入的文本，使用 Backspace 键。不可与 /s 同时使用。 |
| /i   | 大小写不敏感。 |
| /c   | 如果输入文本的首字符为大写，则将首个 [paste](IDP_PASTE.md) 或 [key](IDP_KEY.md) 命令的首字符大写。<ul><li>适用于 `key "text"` 和 `key (variable)`，不适用于 `key text` 或 `str.setsel`。</li><li>**QM 2.3.3**：在整个线程中生效，此前在从自动文本列表调用的函数中无效。</li><li>**QM 2.3.3**：如果输入文本全为大写，则将首个 `paste` 或 `key` 命令的全部文本大写。</li><li>**QM 2.3.3**：此选项包含“大小写不敏感”功能。</li><li>必须设置 /s 或 /b，否则仅在输入文本全为大写时生效。</li></ul> |
| /m   | **QM 2.3.3**：需要确认。显示包含单个项目的弹出列表（见下文）。 |
| /p1  | **QM 2.3.3**：需要分隔符（后缀）触发项目。例如，输入 `test `、`test,` 或 `test.` 触发项目 `test`。分隔符为除字母数字和选项 -> 触发器中指定的字符外的所有字符。 |
| /p2  | **QM 2.3.3**：需要按 Ctrl 触发项目。 |
| /p3  | **QM 2.3.3**：需要分隔符或 Ctrl 触发项目。 |

示例（设置“选择文本”、“大小写不敏感”和“首字母大写”选项）：

```qm
/s/i/c
```

可以为每个项目单独添加或移除选项，使用大写字符移除。例如，`/C/` 表示移除“首字母大写”选项：

```qm
/C/ pw1 :"password1"
```

如果项目文本以 `/` 开头，使用 `//`。

## <a name="MoreOptions"></a>更多选项

可以通过[过滤函数](IDH_TFF.md)添加更多选项，用于定义自动文本列表（全部或部分项目）的生效条件，例如指定窗口、自定义后缀字符集等。

- 获取用户输入文本和其他信息：
  - **QM 2.3.5**：使用 `TriggerInfoAutotext` 函数。
  - **QM 2.3.3**：使用 `TriggerInfoTsMenu` 函数。
  - 这些函数可在自动文本列表的过滤函数和项目代码中使用。

- **QM 2.3.5**：可以使用 `FFT_Autotext_PostfixCustom` 作为自动文本列表的过滤函数示例或模板。

## 多项匹配

**QM 2.3.3**：如果多个项目匹配输入文本，会显示一个弹出列表。

弹出列表的项目文本从项目代码或注释中提取。示例：

```qm
text :'"This will be popup list item text"
text :'"zzzz" ;;This will be popup list item text
```

**键盘快捷键**：
- 选择项目：Enter、Tab、1-9
- 取消：Esc
- 其他：Down/Up 箭头、Home、End、Page Down/Up、F1

若需为单个项目显示弹出列表，使用选项 `/m`。

## 注意事项

- **阻止执行**：在输入项目文本期间（而非之前），可以通过以下方式阻止自动文本列表项目的执行：
  - 在同一窗口内点击鼠标。
  - 按 Ctrl 或其他不输入文本的键（除 Shift、Alt、Win、Backspace 外）。

- **分隔符限制**：如果前一个输入字符为非分隔符（字母数字 + 选项 -> 触发器中指定的字符），自动文本列表项目不会执行，除非触发器为带“Eat”的键。若需强制执行，在输入前执行上述操作（点击、Ctrl 等）。**QM 2.3.3**：若项目文本以分隔符开头且触发器为自动文本，则前一个字符可以是任意字符。

- **声音关联**：可以在选项 -> 声音中为自动文本列表事件关联声音。

- **QM 2.3.3**：在控制台窗口中生效。

- **QM 2.3.3**：移除 5 秒超时。

- **QM 2.3.3**：默认 [opt keymark](IDP_OPT.md) 为 1，使执行更可靠。在调用的函数中为 0。

- **插入文本**：自动文本列表项目通常使用插入文本命令。可以使用键盘（[key](IDP_KEY.md)）或剪贴板（[paste](IDP_PASTE.md)）。对于短文本，建议使用键盘，因其不覆盖剪贴板，但长文本可能较慢。对于简单文本代码（如 `abc :"text"`），QM 根据选项 -> 常规中的[混合粘贴](IDP_PASTE.md)设置选择使用剪贴板或键盘。

- **干扰问题**：可能与其他运行的键盘/自动文本软件或目标程序的类似功能（例如 Microsoft Word 自动更正）发生干扰。