# QM 编程

## 目录
- [预定义命令和函数](#预定义命令和函数)
- [常量](#常量)
- [变量](#变量)
- [运算符](#运算符)
- [函数](#函数)
- [条件语句 (If-else)](#条件语句-if-else)
- [跳转 (Go to)](#跳转-go-to)
- [循环 (Repeat)](#循环-repeat)
- [字符串操作](#字符串操作)
- [错误处理](#错误处理)
- [线程](#线程)

正如 [语法](IDP_SYNTAX.md) 主题所述，QM 宏代码由各种语句组成，包括宏命令、函数、计算、[声明](IDP_DECLARATION.md)、流程控制等编程所需的一切。单行代码可以包含单个语句或多个由分号分隔的语句。注释使用行首的空格，或语句后以两个分号 (`;;`) 开头的文本。行首的制表符用于流程控制语句（如 `if`、`rep` 等）。示例：

```qm
if(a<10)
    lef 5 a "Some Window"; wait 1
    a + 1 ;; 增加 a 的值
else ret
```

## 预定义命令和函数

Quick Macros 拥有大约 200 个内置 [关键字](IDH_REFERENCE.md)，包括宏命令、函数、成员函数、流程控制语句、声明语句、内部类型、编译器指令和运算符。你还可以使用 [DLL 函数](IDP_DLL.md)、[COM 函数](IDH_COM.md) 和 [用户定义函数](IDH_FUNCTION.md)。

QM 提供了多种 [功能](IDH_TYPEINFO.md) 来简化编程。你可以使用 [F1](IDP_F1.md) 获取函数和其他标识符的帮助。这些标识符的基本语法或定义也会显示在 QM 状态栏中。可以通过成员列表浏览和插入可用标识符。某些命令可以通过对话框输入或录制。

## 常量

[常量](IDP_CONSTANT.md) 是简单的数字或字符串值，例如 `45`（整数常量）、`0x1A`（十六进制整数常量）、`10.57`（浮点常量）、`"text"`（字符串常量）。字符串常量用双引号括起来。在字符串中插入双引号使用两个单引号 (`''`)。换行使用 `[]`。常量可以赋值给变量、用作宏命令和函数的参数，或在带有运算符的表达式中使用。你还可以定义 [命名常量](IDP_DEF.md)。

## 变量

[变量](IDH_VARIABLES.md) 用于在运行时临时存储数据（数字、文本等）。数据在各种操作中可以更改。与常量类似，变量可以赋值给其他变量、用作宏命令和函数的参数，或在带有运算符的表达式中使用。

在使用变量之前，必须 [声明](IDH_VARIABLES.md) 变量（[预定义变量](IDP_SPECVAR.md) 除外）。声明包括类型和 [名称](IDP_IDENTIFIERS.md)。常用类型包括 `int`（整数值）、`str`（字符串）和 `double`（浮点值）。以下示例声明了局部变量 `i`（类型 `int`）、局部变量 `S3`（类型 `str`）和全局变量 `g_var`（类型 `double`），然后赋值：

```qm
int i
str S3
double+ g_var
i=5
S3="text"
g_var=15.477
```

你还可以使用 [指针](IDH_POINTERS.md) 和 [数组](IDP_OLE_ARRAY.md)。以下示例声明了 `str` 类型的数组 `a`，分配 10 个元素，然后将字符串 `"abc"` 存储到索引为 0 的元素：

```qm
ARRAY(str) a.create(10)
a[0]="abc"
```

你还可以 [定义新类型](IDP_TYPE.md)。用户定义的类型通常包含多个不同类型的成员变量。例如，类型 `POINT` 包含成员 `x` 和 `y`。以下示例声明了类型为 `POINT` 的变量 `p`，并将其成员 `y` 赋值为 10：

```qm
POINT p
p.y=10
```

## 运算符

[运算符](IDH_OPERATORS.md) 是用于执行赋值、算术、比较或其他操作的特殊符号。以下是一些带注释的示例：

```qm
i = 5 ;; 将 5 赋值给变量 i
i + 2 ;; 给变量 i 增加 2
a = b + 10 ;; 计算 b 和 10 的和并赋值给变量 a
ave = i + j / 2 ;; 将 j 加上 i，除以 2，然后将结果赋值给变量 ave
f = i - (10 * j) + func(a b) * -10 ;; 将 10 和 j 相乘，从 i 中减去结果，调用函数 func 并加上其返回值，再乘以 -10，然后将结果赋值给变量 f
str s = "notepad" ;; 声明变量 s 并赋值字符串 "notepad"
s + ".exe" ;; 追加 ".exe"
if(i<10 and s="notepad.exe") i = j/10 ;; 如果 i 小于 10 且 s 等于 "notepad.exe"，则计算 j / 10 并将结果赋值给变量 i
i = Func2(j s (i + 5) f) ;; 调用函数 Func2 并将其返回值赋值给变量 i；传递四个参数；第三个参数是 i 和 5 的和
lef a-10 100 ;; 左键点击；x 坐标为 a-10，y 坐标为 100
```

在 QM 中，运算符分为三个优先级类别：首先计算算术和位运算符，然后是比较运算符（`=`、`!`、`<` 等），最后是逻辑运算符（`and`、`or`）。同一优先级类别的运算符从左到右计算。可以使用括号更改计算顺序。

另见：[一元运算符](IDP_OPUNARY.md)（`-` 等）、[成员访问运算符](IDP_TYPEUSAGE.md)（`.`）和 [数组元素访问运算符](IDP_OLE_ARRAY.md)（`[]`）。

## 函数

另见：[函数](IDH_FUNCTIONS.md)、[用户定义函数](IDH_FUNCTION.md)、[子函数](IDP_DIR_SUB.md)、[函数提示](IDH_FUNCTIONTIPS.md)。

函数是作为一个单元执行的命名代码块。它可以接收多个值（参数）并返回某个值。除了预定义函数外，你可以创建自己的（用户定义的）函数。通常，当你希望有一段代码可以多次执行时，可以创建函数，而不是在每个宏中重复相同代码。只需要在宏中通过函数名调用即可。与常量和变量类似，函数可以赋值给变量、用作宏命令和其他函数的参数，或在带有运算符的表达式中使用。示例：

```qm
Func a "text" 100 ;; 调用函数 Func，传递三个参数
a = Func2(10) ;; 调用函数 Func2，传递一个参数，并将其返回值赋值给变量 a
Func3(a Func4(b c)) ;; 调用函数 Func4，传递参数 b 和 c，然后调用函数 Func3，传递两个参数（第二个参数是 Func4 的返回值）
d = e + Func5(b c) / 10 ;; 在带有运算符的表达式中使用函数 Func5
```

某些变量类型具有成员函数。成员函数通过该类型的变量调用。示例：

```qm
str s s2="notepad"
s.from(s2 ".exe")
if(s.end(".exe")) out "s ends with '.exe'"
```

要创建新的 [用户定义函数](IDH_FUNCTION.md)，从 File/New 菜单中选择 New Function，并在临时编辑字段中输入函数的 [名称](IDP_IDENTIFIERS.md)。要定义函数的返回类型和参数，在开头使用 [function](IDP_FUNCTION.md) 语句。要返回值，使用 [ret](IDP_RET.md) 语句。默认情况下，函数可以从代码中调用或作为宏启动。若仅允许从代码中调用，首行应为空格和 `/`，如下例所示：

```qm
 /
function'int str'a str&b [int'c]
statements
ret 1
```

此函数返回 `int` 类型的值，包含三个参数（局部变量，接收调用时传递的值）。变量 `a` 和 `c` 接收传递值的副本。变量 `b` 是对传递的 `str` 变量的引用。当函数修改 `b` 时，实际上修改的是该变量。最后一个参数是可选的，即调用者可以省略它，此时 `c` 为 0。函数执行语句并返回 1。如果未通过 `ret` 返回，或 `ret` 没有返回值，则返回值为 0。

## 条件语句 (If-else)

通常需要根据某些条件执行或跳过若干语句。示例：

```qm
if a>0
    out "a is greater than zero" ;; a 大于零
    a-1
else if a=0
    out "a is equal to zero" ;; a 等于零
else
    out "a is less than zero" ;; a 小于零
```

[if](IDP_IF.md) 语句评估某个表达式（在此例中为 `a>0`），如果表达式为真（非零），则允许执行后续的制表符缩进语句。`if` 语句可以与 [else](IDP_IF.md) 语句结合使用，当表达式为假（零）时，执行后续的制表符缩进语句。如示例所示，`else if` 可用于评估更多表达式。语句也可以在同一行：

```qm
if(a>0) out "a is greater than zero" ;; a 大于零; a-1
else if(a=0) out "a is equal to zero" ;; a 等于零
else out "a is less than zero" ;; a 小于零
```

当需要将变量与多个常量值比较时，使用 [sel](IDP_SEL.md) 更方便。

## 跳转 (Go to)

[goto](IDP_GOTO.md) 语句用于跳转到代码中的其他位置。示例：

```qm
goto g1
statements
 g1
statements
```

在此示例中，`goto` 后的语句被跳过，执行从标签 `g1` 后的语句继续。注意，标签前有一个空格（与注释相同）。

## 循环 (Repeat)

[rep](IDP_REP.md) 语句用于重复执行后续的制表符缩进语句。可以选择指定重复次数。使用 `break` 语句退出循环。语句也可以在同一行。示例：

```qm
rep(100) i-1
```

在此示例中，`i-1` 执行 100 次。在以下示例中，`out i` 在 `i` 小于 100 时执行，也是 100 次：

```qm
i=0
rep
    if(i>=100) break
    out i
    i+1
```

你还可以使用 [for](IDP_FOR.md)（带计数器的循环）和 [foreach](IDP_FOREACH.md)。示例：

```qm
for i 0 100
    out i
```

此示例与第二个 `rep` 示例功能相同。最初，变量 `i` 设为 0。然后，`out i` 重复执行，每次循环后 `i` 递增。当 `i` 等于 100 时停止。

## 字符串操作

QM 提供了一组用于处理 [字符串](IDH_STRINGS.md)（文本）的函数。使用 `str` 类型的变量存储和操作字符串。以下示例声明变量 `s` 并赋值字符串 `"Cat"`：

```qm
str s = "Cat" ;; 现在变量 s 为 "Cat"（字符串 "Cat" 存储在变量 s 中）。
```

字符串函数分为两组。第一组是全局函数，用于获取字符串的某些信息（长度、数字值、查找子字符串等）或字符。示例：

```qm
i=val(s) ;; i = 字符串 s 的数字值（若 s 不以数字开头，则为 0）。
i=find(s "substring") ;; i = 字符串 s 中 "substring" 首字符的索引（若未找到，则为 -1）。
if(IsCharLower(s[0])) s[0]=CharUpper(+s[0]) ;; 如果字符串 s 的首字符是小写，将其转换为大写。
```

第二组是 `str` 成员函数，大多用于构建或修改字符串。调用语法略有不同：函数名前面是变量名和点。示例：

```qm
s.from("word1" ", " "word2") ;; 从三个字符串构建字符串变量 s（连接）。现在 s 为 "word1, word2"。这里的 s 是 str 类型的变量。
s.ucase ;; 将 s 转换为大写。现在 s 为 "WORD1, WORD2"。
str ss.get(s 7 5) ;; 声明 str 变量 ss 并获取 s 的部分内容。现在 ss 为 "WORD2"。
```

对于 `str` 变量，可以使用运算符 `+` 和 `-` 进行追加和前置：

```qm
s+" .txt" ;; 追加 ".txt"
s-"C:\Doc\" ;; 前置 "C:\Doc\"
```

比较 `str` 变量时，使用运算符 `=`（相等，区分大小写）、`~`（相等，不区分大小写）和 `!`（不等，区分大小写）。比较字符串部分时，使用 `str` 成员函数 `beg`、`mid` 等。示例：

```qm
if(s~"Monday") ... ;; 如果 s 为 "Monday"（不区分大小写）...
if(s.endi(".exe")) ... ;; 如果 s 以 ".exe" 结尾（不区分大小写）...
```

## 错误处理

运行宏时，QM 会 [编译](IDH_DEBUG.md) 它，包括检查 [语法错误](IDP_ERRORS.md)。发生错误时，QM 会高亮错误位置并提供错误描述。包含错误的宏不会执行。

在运行时，某些条件下宏命令可能失败，QM 会生成运行时错误，宏将终止。[err](IDP_ERR.md) 语句允许在上一语句发生运行时错误后继续执行。示例：

```qm
clo "Notepad"; err

5 "Notepad"
err
    run "$system$\notepad.exe"
```

在第一个示例中，`err` 允许在发生错误时继续执行。在第二个示例中，发生错误时执行 `run "$system$\notepad.exe"` 语句，否则该语句不会执行。

## 线程

[线程](IDP_THREADS.md) 是运行程序中的子程序。在 QM 中，线程是运行的宏或函数，包括其调用的所有函数。多个 [函数](IDH_FUNCTION.md) 线程可以同时运行，包括同一函数的多个实例。如果宏具有“同时运行”选项，多个 [宏](IDH_MACRO.md) 线程也可以同时运行。