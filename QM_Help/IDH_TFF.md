# 过滤器函数

**警告**：不当使用过滤器函数可能降低系统性能和稳定性。

过滤器函数通常用于缩小触发器范围，在 QM 即将启动分配了过滤器函数的宏时调用。根据函数返回值，QM 决定是否启动宏、启动其他宏或不执行任何操作。过滤器函数可使宏特定于某个窗口、窗口部分、控件、鼠标位置、时间等，尤其在触发器“吃掉”事件（**Properties** 中勾选“Eat”）时特别有用。

## 设置过滤器函数

具有触发器（键盘、鼠标、窗口或自动文本）的宏可分配过滤器函数。在 [Properties](IDH_PROPERTIES.md) 对话框中点击 **FF** 按钮，打开 **Filter Function** 对话框：
- **Use**：从下拉列表选择现有过滤器函数。
- **New**：创建新过滤器函数，或点击 **Copy** 复制现有函数并可选输入新名称。
- 也可在工具栏的 [Trigger](IDP_TRIGGER_CODING.md) 字段直接指定过滤器函数。

## 过滤器函数定义

过滤器函数是普通用户定义函数，需自行编写代码，函数开头必须为：

```qm
/
function# iid FILTER&f
```

- **iid**：[宏的标识符](IDP_QMITEM.md)，表示即将运行的宏（分配了此过滤器函数的宏）。
- **f**：`FILTER` 类型变量，结构如下：

```qm
type FILTER hwnd hwnd2 x y hit !itype !ttype !tkey !tmod !tkey2 []!tmon []!tht
```

### FILTER 类型成员

- **hwnd**：[顶级窗口句柄](IDP_WINDOWEXPRESSION.md)：
  - 窗口触发器：触发窗口。
  - 鼠标点击触发器：点击的窗口。
  - 其他触发器：活动窗口。
- **hwnd2**：子窗口或顶级窗口句柄：
  - 键盘触发器：焦点窗口（可能为 0）。
  - 鼠标触发器：鼠标所在窗口。
  - 其他触发器：0。
- **x, y**：鼠标坐标，仅用于鼠标触发器。
- **hit**：鼠标触发器的命中测试代码，详见 [WM_NCHITTEST](http://www.google.com/search?q=site%3Amicrosoft.com+WM_NCHITTEST)。
- 其他成员：提供宏信息，与 [QMITEM](IDP_QMITEM.md) 相同。

## 返回值

### 键盘、鼠标和窗口触发器

| 返回值 | 操作 |
|-------|------|
| `iid` | 运行分配的宏，其他具有相同触发器的宏不运行。 |
| 其他宏的 ID 或名称 | 运行指定宏，例如根据条件（如活动窗口、鼠标位置）选择要运行的宏。 |
| 0 | 不运行，阻止其他具有相同触发器的宏运行。 |
| -1 | 不运行，若 **Properties** 中勾选“Eat”，则吃掉触发事件。通常用于过滤器函数自行启动其他宏（[mac](IDP_MAC.md)）。 |
| -2 | 不运行，允许其他具有相同触发器的宏可能运行。 |

### [自动文本](IDH_TSM.md) 触发器

| 返回值 | 操作 |
|-------|------|
| `iid` | 运行自动文本列表项，其他具有相同触发器的列表不运行。 |
| 0 或 -1 | 不运行，阻止其他具有相同触发器的列表运行。 |
| -2 | 不运行，允许其他具有相同触发器的列表可能运行。 |

## 使用场景

- 过滤器函数通常专用于单一宏，但也可分配给具有不同触发器的多个宏。
- 若多个宏需使用同一触发器但在不同窗口运行，可为其中一个宏（或过滤器函数本身）分配触发器和过滤器函数，函数根据条件选择运行的宏。

## 评估条件

过滤器函数通过 `iid` 和 `f` 变量获取触发器信息，可使用以下函数评估：
- [sel](IDP_SEL.md)
- [wintest](IDP_WIN.md)
- [getwintext, getwinclass](IDP_S_WINDOW.md)
- `GetWinId`, `GetWinStyle`, `GetWinXY`
- [child, childtest](IDP_CHILD.md)
- [id](IDP_ID.md)
- [qmitem](IDP_QMITEM.md)
- [getmacro](IDP_S_MACRO.md)

`f` 变量的信息含义因触发器类型（键盘、鼠标等）而异，专为一种触发器设计的过滤器函数通常不适用于其他类型。

## 注意事项

- **性能**：过滤器函数运行时，目标应用程序暂停处理用户输入，因此需尽量快速，仅评估条件或启动其他宏（[mac](IDP_MAC.md)），不得包含宏命令（如鼠标、窗口、等待、对话框等）。最大允许执行时间为 1 秒，可用 [perf](IDP_PERF.md) 测量时间。
- **限制**：函数运行时，目标应用程序正在处理输入事件，因此某些与窗口通信的代码（如 [acc](IDP_ACC.md)(mouse)）可能无效。
- **线程**：键盘、鼠标和窗口触发器的过滤器函数运行在单一特殊 [线程](IDP_THREADS.md)，自动文本触发器的函数运行在 QM 主线程。
- **禁用**：若过滤器函数被禁用，分配的宏将如无过滤器函数般运行。

## 编辑和应用

编辑过滤器函数后，点击 **Save** 或 **Compile** 按钮应用更改。

## 模板和示例

提供多种过滤器函数模板，具体示例见 [示例](IDH_TFF_EXAMPLES.md)。