# 格式字段

格式字段用于 [str.format](IDP_S_FORMAT.html)、`out`、`paste` 函数以及 [F 运算符](IDP_FSTRING.html)。格式字段是以 `%` 开头的特殊字符或字符序列，后跟变量或其他值，用于替换格式字段并控制值的格式化方式。

## 语法

```qm
%[flags][width][.precision][h|l|I64|L]type
```

### 组成部分
- **[type](#type)**：指定参数类型（字符、字符串、数字等）。
- **[flags](#flags)**：控制输出的对齐、符号、空白、十进制点及八/十六进制前缀。
- **[width](#width)**：指定输出的最小字符数。
- **[precision](#precision)**：指定输出的最大字符数、十进制位数或有效数字。
- **[h, l, I64, L](#size)**：指定参数大小（如 `long` 使用 `I64`）。**注意**：`I64` 中的 `I` 为大写字母 `I`，非小写 `L`。

## 备注
- `%%` 在格式字符串中被替换为 `%`。
- 格式化规则与 C/C++ 的 `printf`、`sprintf` 等函数几乎相同，差异如下：
  - 不为 null 字符串添加 `(null)`。
  - QM 2.3.3 支持二进制数据（`%m`）。

## 示例
```qm
int i=50
str s="stringvar"
double d=3.1415926535897932384626433832795
str f
f.format("variables: i=%i, s='%s', d=%.10G" i s d)
out f ;; variables: i=50, s="stringvar", d=3.141592654
```

## <a name="type"></a>类型 (type)
`type` 指定参数的解释方式（数字、字符串、字符等）。

| 字符 | 类型 | 输出格式 |
|------|------|----------|
| `i`, `d` | integer | 有符号十进制整数。例如：`int i=5; out "i=%i" i` 输出 `i=5` |
| `u` | integer | 无符号十进制整数 |
| `x` | integer | 无符号十六进制整数（小写 `abcdef`） |
| `X` | integer | 无符号十六进制整数（大写 `ABCDEF`） |
| `e` | double | 有符号值，格式为 `[-]d.dddd e [+-]ddd`，`d` 为单个十进制数字，`dddd` 为一个或多个十进制数字，`ddd` 为三位十进制数字 |
| `E` | double | 同 `e`，但使用大写 `E` 表示指数 |
| `f` | double | 有符号值，格式为 `[-]dddd.dddd`，整数部分数字数量取决于值大小，小数部分由精度指定 |
| `g` | double | 使用 `f` 或 `e` 格式（取更紧凑者）。仅当指数小于 -4 或大于等于精度时使用 `e`。去掉尾随零，仅当有后续数字时显示小数点 |
| `G` | double | 同 `g`，但使用大写 `E` 表示指数 |
| `s` | string | 输出字符串直到空字符或达到精度 |
| `S` | word* | QM 2.3.3，Unicode UTF-16 字符串。例如：`BSTR b="utf-16 string"; out "%S" b.pstr` |
| `c` | integer | [字符代码](IDP_ASCII.html)。**注意**：Unicode 模式下避免使用非 ASCII 字符 |
| `C` | integer | QM 2.3.3，Unicode UTF-16 字符代码，需 `<0x10000` |
| `m` | pointer | QM 2.3.3，二进制数据，需通过精度指定长度。例如：`_s.format("%.*m" 10 ptr)` 输出 `ptr` 的 10 字节 |
| `m` | byte | QM 2.3.3，填充 ASCII 字符，需通过精度指定长度。例如：`out "%.*m" 4 '*'` 输出 `****`。若字符代码为 0，使用参数值 `0x100` |

## <a name="flags"></a>标志 (flags)
`flags` 控制输出的对齐、符号、填充等，可组合使用。

| 标志 | 含义 | 默认值 |
|------|------|--------|
| `-` | 左对齐输出，填充到指定宽度 | 右对齐 |
| `+` | 为有符号值添加符号（`+` 或 `-`） | 仅负值显示符号（`-`） |
| `0` | 用 0 填充到最小宽度。若与 `-` 共存，忽略 `0`。对整数格式（`i`, `u`, `x`, `X`, `o`, `d`）忽略 `0` | 无填充 |
| 空格 | 为正有符号值添加前置空格。若与 `+` 共存，忽略空格 | 无前置空格 |
| `#` | 对 `o`, `x`, `X` 格式，非零值分别添加前缀 `0`, `0x`, `0X` | 无前缀 |
| `#` | 对 `e`, `E`, `f` 格式，强制显示小数点 | 小数点仅在有后续数字时显示 |
| `#` | 对 `g`, `G` 格式，强制显示小数点且保留尾随零 | 小数点仅在有后续数字时显示，尾随零被截断 |
| `#` | QM 2.3.3，对 `s` 格式，指定精度为字符数而非字节数（Unicode 模式下非 ASCII 字符占多字节）。例如：`out "%#.5s" "ąčęėįšųūž"` | 默认按字节数 |

## <a name="width"></a>宽度 (width)
`width` 为十进制整数，指定输出的最小字符数。若输出字符数少于指定宽度，根据 `-` 标志在左或右填充空格。若以 `0` 开头，用 0 填充（对左对齐或整数格式无效）。

- 宽度不会导致值截断。若输出字符数超过指定宽度，或未指定宽度，则输出所有字符。
- 若宽度为 `*`，则从参数列表的 `int` 参数获取宽度，需在被格式化的值之前。例如：
  ```qm
  out "%*s" 20 "string"
  ```

## <a name="precision"></a>精度 (precision)
`precision` 为非负十进制整数，以 `.` 开头，指定输出的字符数、小数位数或有效数字。精度可能导致输出截断或浮点值四舍五入。

| 类型 | 含义 | 默认值 |
|------|------|--------|
| `c`, `C` | 无影响 | 无 |
| `d`, `i`, `u`, `o`, `x`, `X` | 指定最小数字数，少于精度时左补零，超精度不截断 | 精度为 1 |
| `e`, `E` | 指定小数点后数字数，最后一位四舍五入 | 精度为 6，若精度为 0 或 `.` 无后续数字，不显示小数点 |
| `f` | 指定小数点后数字数，至少有一位整数部分，值四舍五入 | 精度为 6，若精度为 0 或 `.` 无后续数字，不显示小数点 |
| `g`, `G` | 指定最大有效数字数 | 输出 6 位有效数字，截断尾随零 |
| `s`, `S` | 指定最大字符数，超精度部分不输出。**注意**：对 `s`，精度为字节数，Unicode 模式下非 ASCII 字符占多字节。QM 2.3.3 可使用 `#` 标志指定字符数 | 输出至空字符 |
| `m` | 指定输出的字节数 | 0 |

### 示例
```qm
str s.format("%.4s %.3f" "123456789" 1.12345)
out s ;; 1234 1.123
```

若精度为 `*`，则从参数列表的 `int` 参数获取精度，需在被格式化的值之前。例如：
```qm
str s.format("%.*s %.*f" 4 "123456789" 3 1.12345)
out s ;; 1234 1.123
```

## <a name="size"></a>参数大小
对于 `long` 类型参数，需指定大小 `I64`。例如：
```qm
long k=123456789012345
out "incorrect: %i" k
out "correct: %I64i" k
```

其他类型通常无需指定大小，以下为完整表格：

| 参数类型 | 前缀 | 适用类型 |
|----------|------|----------|
| int | `l` | `d`, `i`, `o`, `x`, `X` |
| unsigned int | `l` | `u` |
| signed word | `h` | `d`, `i`, `o`, `x`, `X` |
| word | `h` | `u` |
| long | `I64` | `d`, `i`, `o`, `u`, `x`, `X` |
| 单字节字符 | `h` | `c`, `C` |
| 宽字符 | `l` | `c`, `C` |
| 单字节字符串 | `h` | `s`, `S` |
| 宽字符字符串 | `l` | `s`, `S` |