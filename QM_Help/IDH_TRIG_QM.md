# 触发器：QM 事件

## 概述

在 Quick Macros 的特定事件发生时触发宏的执行。可以使用属性对话框分配此触发器。

## 触发器类型

### 启动

这些事件在打开[QM 文件](IDH_QML.md)时发生，例如 QM 启动时。如果选中“Run synchronously”，QM 将等待函数结束，因此函数应快速执行以避免 QM 启动延迟。`_command` 变量的值如下：
- "1"：文件更改时
- "2"：QM 启动时
- "3"：Windows 启动时（QM 以命令行参数 S 启动）

这些事件可能按以下顺序发生：文件加载、QM 启动、Windows 启动。

如果存在名为 `init2` 的用户定义函数，它将在打开 QM 文件时调用，先于其他函数/宏，在初始化 QM 扩展后执行，无需触发器。

### 退出

这些事件在关闭 QM 文件时发生，例如在 QM 退出之前。函数同步运行，应快速执行。`_command` 变量的值如下：
- "1"：文件更改时
- "2"：QM 退出时
- "3"：Windows 关闭/重启/注销时

这些事件可能按以下顺序发生：Windows 退出、QM 退出、文件卸载。

### 托盘图标

这些事件在点击 QM 托盘图标时发生。这些触发器会禁用默认 QM 操作（左键单击显示 QM、Ctrl+左键退出 QM、右键显示菜单、中键启用/禁用）。

### 触发器管理

用于[用户定义触发器](IDH_TRIG_EXT.md)。

### 添加到菜单

具有此触发器的 QM 项目会被添加到 QM 菜单栏、“新建”菜单或托盘菜单中。

**QM 2.2.0**：菜单栏触发器启动宏时带两个参数，表示[弹出菜单](IDH_POPUP.md)应显示的 x 和 y 坐标。

**QM 2.2.0**：对于具有菜单栏触发器的宏和菜单，可在宏名称中包含 `&` 字符，之后的字符将在菜单栏中显示为下划线，可通过键盘显示菜单。

### 文件链接运行 (QM 2.3.0)

当类型为[文件链接](IDH_ITEMS.md)的 QM 项目启动时运行。可指定文件名模式，仅对特定文件类型或文件运行。支持通配符 `*`（匹配 0 个或多个字符）和 `?`（匹配任意单个字符）。通过属性对话框分配触发器时，会插入提供文件链接项目[id](IDP_QMITEM.md)和其文件路径的代码。

### 结束线程 (QM 2.3.0)

当用户在“线程”对话框或“运行项目”列表中尝试结束线程时运行。如果函数返回 0，QM 不会结束线程。函数可以显示警告消息框、静默拒绝用户请求，或以特殊方式正确结束线程。

### QM 显示/隐藏 (QM 2.3.3)

- **QM 显示**：当 QM 窗口显示时运行，例如点击托盘图标时。
  - **QM 2.4.1**：新增“Run synchronously”选项。函数在显示 QM 窗口前运行，如果返回非 0，QM 窗口保持隐藏。以下是密码保护示例：

    ```qm
    if(!inpp("p" "Password to show window" "Quick Macros")) ret 1
    ```

- **QM 隐藏**：当 QM 窗口隐藏时运行，例如点击关闭按钮（X）时。不在 QM 退出时触发。

### 录制结束 (QM 2.3.3)

当录制结束时运行（取消时除外）。必须是函数，接收录制的宏字符串，并可修改它。