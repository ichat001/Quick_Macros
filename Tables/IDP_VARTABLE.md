# 变量类型：转换与相关操作

以下表格列出了 QM 中的变量类型、赋值时的类型检查与转换、内存管理以及在表达式中的行为。

| 类别 | 类型 | 赋值右侧允许的类型 | 注释 | 离开作用域时 | 表达式中的行为 |
|------|------|------------------|------|------------|----------------|
| **基本类型** | `int` | 除 [结构](IDP_TYPE.html) 外的任意类型 | 从 `str` 和 `lpstr` 接收字符串指针，从 `BSTR` 和 `VARIANT` 获取数值（必要时从字符串转换） | 无 | `int` |
| | `byte` | 除结构外的任意类型 | 同上 | 无 | `int` |
| | `word` | 除结构外的任意类型 | 同上 | 无 | `int` |
| | `long` | 除结构外的任意类型 | 同上 | 无 | `long` |
| | `double` | 除结构外的任意类型 | 同上 | 无 | `double` |
| | `lpstr` | 字符串（`lpstr`, `str`, `BSTR`, `VARIANT(BSTR)`）、`byte*`、0 | 从 `str` 和 `lpstr` 接收指针值，`BSTR` 转换为隐藏的局部 `str` 变量 | 无 | `lpstr` 或 `unsigned int` |
| | `str` | 除结构外的任意类型 | 复制字符串，将数值类型转换为字符串 | 释放字符串 | `lpstr` 或 `unsigned int` |
| **OLE 类型** | `FLOAT` | [基本和 OLE 类型](IDH_VARIABLES.html) | 将字符串转换为数值 | 无 | `double` |
| | `DATE` | 基本和 OLE 类型 | 同上 | 无 | `double` |
| | `CY` | 基本和 OLE 类型 | 同上 | 无 | `double` |
| | `DECIMAL` | 基本和 OLE 类型 | 同上 | 无 | `double` |
| | `BSTR` | 基本和 OLE 类型 | 复制字符串，将数值类型转换为字符串 | 释放字符串 | `double` |
| | `VARIANT` | 除结构外的任意类型 | 复制所有数据，内部调用 `AddRef`、`Release`、`QueryInterface` 等 | 释放/调用 `Release` | `double` |
| | `ARRAY` | 相同类型的 `ARRAY`、`VARIANT`、字符串 | 复制所有元素及相关数据，调用所需函数 | 同上 | 不可用 |
| **结构** | `structure` | 相同类型的结构 | 复制所有数据，调用所需函数 | 同上 | 不可用 |
| **接口指针** | `interface pointer` | 相同类型的接口指针、0、`IUnknown`、`IDispatch`、`VARIANT` | 调用 `AddRef`，对先前接口指针调用 `Release`，若类型不同则调用 `QueryInterface` | 调用 `Release` | 不可用 |
| **指针** | `pointer` | 相同类型的指针、0、`byte*` | 函数的引用类型参数也视为指针 | 无 | `pointer` 或 `unsigned int` |
| | `byte*` | 任意类型的指针、0、接口指针、`str`、`lpstr` | 类似于 C 的 `void*` 或 VB 的 `Any` | 无 | `pointer` 或 `unsigned int` |
| | `reference` | 与变量相同 | 与变量相同 | 无操作 | 与变量相同 |

## 列说明
1. **类别**：变量类型的分组。
2. **类型**：变量类型或类型组。
3. **赋值右侧允许的类型**：赋值操作（使用 `=`、函数参数传递、[ret](IDP_RET.md) 返回）右侧允许的类型。
4. **注释**：赋值时的行为、转换规则等。
5. **离开作用域时**：变量销毁（离开作用域）时的内存释放行为。
6. **表达式中的行为**：变量在带有运算符的表达式中的解释方式。

## 注意事项
1. **类型检查**：函数参数的类型检查较严格，`=` 和 `ret` 较宽松。
2. **内存管理**：当 `str`、`BSTR`、`VARIANT`、`ARRAY` 或接口指针作为函数参数或返回值（用户定义函数除外）时，QM 不复制关联数据，也不调用 `AddRef`（由函数自行处理）。
3. **结构**：指表格中未列出的用户定义类型。