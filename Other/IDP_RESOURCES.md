# 宏资源

在宏中，您可能需要使用图像或其他二进制（非文本）数据。存储此类数据的方式包括：

- **外部文件**：例如，图标的 `.ico` 文件。
- **转换为文本**：如十六进制或 base64 格式，存储在宏中。
- **宏资源**：QM 2.4.1 新增，QM 2.4.0 部分支持。

每个宏（或其他 [QM 项目](IDH_ITEMS.md)）可包含任意数量的资源，存储在同一 [QM 文件](IDH_QML.md) 中。资源随宏删除而删除，随宏克隆或导出而复制，可类比为电子邮件附件。

## 资源命名

资源名称区分大小写，部分名称被 QM 识别为图像：

- 以 `image:` 开头的资源为 LZO 压缩的位图（`.bmp` 文件）图像。
- 以 `.bmp`、`.png`、`.jpg`、`.gif`、`.ico`、`.cur` 或 `.ani` 结尾的资源为图像、图标或光标，数据格式与文件相同。

在宏中使用资源时，需加 `resource:` 前缀，例如：

```qm
"resource:email.ico"
```

- 若名称以 `image:` 开头，前缀可省略，例如：`"image:button1"`。
- 若资源位于其他宏，需使用 `resource:<macro name>` 前缀，例如：`"resource:<macro1>image:button1"`、`"resource:<icons>email.ico"`。某些情况下，即使在同一宏也需指定宏名。宏名也可使用 [GUID](IDP_GUID.md)。
- 若未指定宏名，QM 通常可在函数调用栈中的调用者函数中查找资源。
- 未附加到宏的资源称为**文件资源**，在“Resources”对话框中选择 `<file>` 管理，使用前缀 `resource:<>`，例如：`"resource:<>email.ico"`。不要在 [共享文件](IDH_QML.md) 中使用文件资源，因 QM 仅在当前主文件中查找。

## 支持资源的函数

以下函数支持资源：

- `scan`：支持 `image:`、`.bmp`、`.png` 和 `.ico` 资源。
- `GetFileIcon`：支持 `.ico`、`.cur`、`.ani`。
- `LoadPictureFile`：支持 `image:`、`.bmp`、`.png`、`.jpg`、`.gif`。
- `__ImageListLoad`：支持 `image:`、`.bmp`。
- `ShowDialog`（图像、背景、图标）：支持所有图像资源。
- [str.getfile](IDP_S_FILE.md)：支持所有资源，另包括 `IXml.FromFile`、`ICsv.FromFile`、`RichEditLoad` 等。
- `bee`：支持 `.wav`。
- 使用上述函数的函数，例如 `AddTrayIcon`、`__ImageList.Load`。
- [#exe addfile](IDP_DIR_EXE.md)。
- 菜单和工具栏图标：支持 `.ico`。
- QM 项目图标、exe 图标：支持 `.ico`。

## 代码编辑器中的图像显示

在代码编辑器中，QM 在包含图像资源名称和文件路径的字符串下方显示图像，即使字符串在注释中（需用 `""` 括起来）。通过工具栏按钮 **Images in code editor** 控制显示/隐藏图像。图像也可显示在 [输出和函数帮助](IDP_F1.md) 中。

## 录制屏幕截图

在 **Options** 中可设置录制鼠标点击或使用 Mouse 对话框时保存截图。QM 将截图保存为以 `~:` 开头的宏资源，名称作为注释插入宏文本。未使用的截图资源（例如包含 `~:...` 的宏文本被删除后关闭宏）会自动删除。

## 创建可执行文件

创建 [exe](IDH_MAKEEXE.md) 时，QM 查找以 `resource:` 或 `image:` 开头的字符串，将宏资源添加到 exe 资源（与宏资源不同但类似）。exe 中的 QM 函数从这些 exe 资源获取数据，支持多行字符串。若资源未自动添加（例如未在宏中使用完整名称字符串），使用 [#exe addfile](IDP_DIR_EXE.md)。

exe 资源类型和名称（或 ID）取决于宏资源名称：
- 若名称包含冒号（如 `A:B`），在 exe 中，`A` 为资源类型，`B` 为名称。
- 否则，exe 资源名称与宏资源名称相同，类型取决于宏资源名称：
  - 以 `.bmp`、`.ico`、`.cur` 或 `.ani` 结尾，类型分别为 `RT_BITMAP`、`RT_GROUP_ICON`、`RT_GROUP_CURSOR` 或 `RT_ANICURSOR`。
  - 其他为 `RT_RCDATA`。
- 若类型或名称字符串以 1-65535 的整数开头，在 exe 资源中为数字 ID，否则为字符串。例如，宏资源名称 `10 info.ico` 在 exe 中为 `RT_GROUP_ICON` 资源，ID 为 10。
- **注意**：若 exe 包含字符串名称的图标资源，Windows 资源管理器可能显示错误图标；为避免此问题，所有添加到 exe 的图标资源应使用数字名称。

[子函数](IDP_DIR_SUB.md) 不能拥有资源，但可使用父 QM 项目的资源。

## 管理宏资源

管理宏资源的方式：

- **Resources 对话框**：位于 **Tools** 菜单或工具栏。
- **Find Image 对话框**：用于捕获图像。
- [QM 文件管理函数](IDP_QMFILE.md)。

## Resources 对话框

对话框位于 **Tools** 菜单或工具栏。

- **左侧**：列出所有包含资源的 QM 项目（宏等）。
- **右侧**：显示选中项目的资源。

### 左侧特殊项目

- `<this>`：当前在代码编辑器中打开的宏。打开其他宏时，对话框更新显示其资源。若宏无资源，仅显示 **Add** 链接。
- `<all>`：单一视图显示所有宏的资源。
- `<duplicate>`：不同宏或不同名称但数据相同的资源。
- `<unused>`：名称未在任何宏文本（或图标）中使用的资源。
- `<size>`：按大小排序的所有宏资源。
- `<file>`：未附加到任何 QM 项目的文件资源。

### 右侧资源管理

- 点击 **Add** 链接从文件或其他宏添加资源，或从 Windows 资源管理器拖放文件。
- 点击资源名称链接可删除、重命名、导出等。
- 导出 `image:...` 资源时，QM 解压并保存为 `.bmp` 文件。导入 `.bmp` 文件时，若勾选 **Compress**，导入为 `image:...` 资源。其他文件/资源原样导入/导出。
- 导入 `.ico` 文件时，建议资源名称以数字开头，用于 exe 资源 ID。
- 将资源从宏 A 移动或复制到宏 B：
  - 打开宏 A 的资源（或 `<all>` 等），可选选中包含资源名称的文本（链接）。
  - 用右键拖动行或选中文本，释放到左侧宏 B。若需复制，按住 Ctrl。
  - 或将选中文本复制到剪贴板，打开宏 B 的资源，点击 **Add** 链接。
  - 或点击资源名称选择 **Move...**，然后在 B 的资源中点击 **Add**。
  - 若需多选，先正常选择一个，再用 Ctrl 选择更多。
- 打开宏：点击右侧宏名称链接，或左侧双击，或按 Enter。
- 筛选资源：使用 **Filter** 字段，仅显示名称匹配的资源，支持 [SQLite GLOB](IDP_WILDCARD.md) 风格的通配符，可在开头使用 NOT 操作符。
- 查找资源：在 `<all>` 中选择，输入资源名称到 **Filter** 字段，使用通配符（如 `*partOfName*`）查找部分名称，需区分大小写。